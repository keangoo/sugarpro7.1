/*********************************************************************************
     * By installing or using this file, you are confirming on behalf of the entity
     * subscribed to the SugarCRM Inc. product ("Company") that Company is bound by
     * the SugarCRM Inc. Master Subscription Agreement (“MSA”), which is viewable at:
     * http://www.sugarcrm.com/master-subscription-agreement
     *
     * If Company is not bound by the MSA, then by installing or using this file
     * you are agreeing unconditionally that Company will be bound by the MSA and
     * certifying that you have authority to bind Company accordingly.
     *
     * Copyright (C) 2004-2013 SugarCRM Inc.  All rights reserved.
     ********************************************************************************/
({tagName:"span",initialize:function(opts){app.view.View.prototype.initialize.call(this,opts);this._select2formatSelectionTemplate=app.template.get("filter-module-dropdown.selection-partial");this._select2formatResultTemplate=app.template.get("filter-module-dropdown.result-partial");this.listenTo(this.layout,"filter:change:module",this.handleChange);this.listenTo(this.layout,"filter:render:module",this._render);},_render:function(){app.view.View.prototype._render.call(this);if(this.layout.showingActivities){this.filterList=this.getModuleListForActivities();}else if(this.layout.layoutType==="record"){this.filterList=this.getModuleListForSubpanels();}else{this.$el.hide();return this;}
this._renderDropdown(this.filterList);},_renderDropdown:function(data){var self=this;this.filterNode=this.$(".related-filter");this.filterNode.select2({data:data,multiple:false,minimumResultsForSearch:7,formatSelection:_.bind(this.formatSelection,this),formatResult:_.bind(this.formatResult,this),dropdownCss:{width:'auto'},dropdownCssClass:'search-related-dropdown',initSelection:_.bind(this.initSelection,this),escapeMarkup:function(m){return m;},width:'off'});if(this.layout.layoutType!=="record"||this.layout.showingActivities){this.filterNode.select2("disable");}
this.filterNode.off("change");this.filterNode.on("change",function(e){var linkModule=e.val;if(self.layout.layoutType==="record"&&linkModule!=="all_modules"){linkModule=app.data.getRelatedModule(self.module,linkModule);}
self.layout.trigger("filter:change:module",linkModule,e.val);});},handleChange:function(linkModuleName,linkName,silent){if(linkName==="all_modules"){this.layout.trigger("subpanel:change");app.cache.cut("subpanels:last:"+this.module);}else if(linkName&&linkName!=='all_modules'){this.layout.trigger("filter:create:close");this.layout.trigger("subpanel:change",linkName);app.cache.set("subpanels:last:"+app.controller.context.get('module'),linkName);}
if(this.filterNode){this.filterNode.select2("val",linkName||linkModuleName);}
if(!silent){this.layout.layout.trigger("filter:change",linkModuleName,linkName);this.layout.trigger("filter:get",linkModuleName,linkName);this.layout.trigger('filter:clear:quicksearch');}},getModuleListForSubpanels:function(){var filters=[];filters.push({id:"all_modules",text:app.lang.get("LBL_TABGROUP_ALL")});var subpanels=this.pullSubpanelRelationships();subpanels=this._pruneHiddenModules(subpanels);_.each(subpanels,function(value,key){var module=app.data.getRelatedModule(this.module,value);if(app.acl.hasAccess("list",module)){filters.push({id:value,text:app.lang.get(key,this.module)});}},this);return filters;},getModuleListForActivities:function(){var filters=[],label;if(this.module=="Activities"){label=app.lang.get("LBL_TABGROUP_ALL");}else{label=app.lang.get('LBL_MODULE_NAME',this.module);}
filters.push({id:'Activities',text:label});return filters;},pullSubpanelRelationships:function(){return app.utils.getSubpanelList(this.module);},_pruneHiddenModules:function(subpanels){var hiddenSubpanels=_.map(app.metadata.getHiddenSubpanels(),function(subpanel){return subpanel.toLowerCase();});var pruned=_.reduce(subpanels,function(obj,value,key){var relatedModule=app.data.getRelatedModule(this.module,value);if(!_.contains(hiddenSubpanels,relatedModule.toLowerCase())){obj[key]=value;}
return obj;},{},this);return pruned;},initSelection:function(el,callback){var selection,label;if(el.val()==="all_modules"){label=(this.layout.layoutType==="record")?app.lang.get("LBL_TABGROUP_ALL"):app.lang.get("LBL_MODULE_NAME",this.module);selection={id:"all_modules",text:label};}else if(_.findWhere(this.filterList,{id:el.val()})){selection=_.findWhere(this.filterList,{id:el.val()});}else if(this.filterList&&this.filterList.length>0){selection=this.filterList[0];}
callback(selection);},formatSelection:function(item){var selectionLabel,safeString;safeString=Handlebars.Utils.escapeExpression(item.text);this.$('.choice-related').html(safeString);if(this.layout.layoutType!=="record"||this.layout.showingActivities){selectionLabel=app.lang.get("LBL_MODULE");}else{selectionLabel=app.lang.get("LBL_RELATED")+'<i class="icon-caret-down"></i>';}
return this._select2formatSelectionTemplate(selectionLabel);},formatResult:function(option){return this._select2formatResultTemplate(option.text);},_dispose:function(){if(!_.isEmpty(this.filterNode)){this.filterNode.select2('destroy');}
app.view.View.prototype._dispose.call(this);}})