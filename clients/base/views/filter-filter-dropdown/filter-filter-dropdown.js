/*********************************************************************************
     * By installing or using this file, you are confirming on behalf of the entity
     * subscribed to the SugarCRM Inc. product ("Company") that Company is bound by
     * the SugarCRM Inc. Master Subscription Agreement (“MSA”), which is viewable at:
     * http://www.sugarcrm.com/master-subscription-agreement
     *
     * If Company is not bound by the MSA, then by installing or using this file
     * you are agreeing unconditionally that Company will be bound by the MSA and
     * certifying that you have authority to bind Company accordingly.
     *
     * Copyright (C) 2004-2013 SugarCRM Inc.  All rights reserved.
     ********************************************************************************/
({tagName:"span",events:{"click .choice-filter":"handleEditFilter"},initialize:function(opts){app.view.View.prototype.initialize.call(this,opts);this._select2formatSelectionTemplate=app.template.get("filter-filter-dropdown.selection-partial");this._select2formatResultTemplate=app.template.get("filter-filter-dropdown.result-partial");this.listenTo(this.layout,"filter:change:filter",this.handleChange);this.listenTo(this.layout,"filter:change:module",this.handleModuleChange);this.listenTo(this.layout,"filter:render:filter",this._renderHtml);},filterDropdownEnabled:true,_renderHtml:function(){app.view.View.prototype._renderHtml.call(this);this.filterList=this.getFilterList();this._renderDropdown(this.filterList);},getFilterList:function(){var filters=[];this.layout.filters.each(function(model){var isAllRecords=model.id!=="all_records"?false:true;filters.push({id:model.id,text:this.getTranslatedSelectionText(isAllRecords,model.get("name"))});},this);if(this.layout.canCreateFilter()){filters.push({id:"create",text:app.lang.get("LBL_FILTER_CREATE_NEW")});}
return filters;},_renderDropdown:function(data){var self=this;this.filterNode=this.$(".search-filter");this.filterNode.select2({data:data,multiple:false,minimumResultsForSearch:7,formatSelection:_.bind(this.formatSelection,this),formatResult:_.bind(this.formatResult,this),dropdownCss:{width:'auto'},dropdownCssClass:'search-filter-dropdown',initSelection:_.bind(this.initSelection,this),escapeMarkup:function(m){return m;},width:'off'});if(!this.filterDropdownEnabled){this.filterNode.select2("disable");}
this.filterNode.off("change");this.filterNode.on("change",function(e){self.layout.trigger("filter:change:filter",e.val);});},handleChange:function(id){var filter=this.layout.filters.get(id)||this.layout.emptyFilter;if(id==="create"){this.$('.choice-filter').css("cursor","not-allowed");this.layout.trigger("filter:create:open",app.data.createBean('Filters'));}else{if(filter.get("editable")===false){this.layout.trigger("filter:create:close");this.$('.choice-filter').css("cursor","not-allowed");}else{this.$('.choice-filter').css("cursor","pointer");}
if(this.layout.createPanelIsOpen()){this.layout.trigger("filter:create:open",filter);}}
this.filterNode.select2("val",id);},initSelection:function(el,callback){var data,model,val=el.val();if(val!=="create"){model=this.layout.filters.get(val);if(model){if(val!=="all_records"){data={id:model.id,text:this.getTranslatedSelectionText(false,model.get("name"))};}else{data={id:"all_records",text:this.getTranslatedSelectionText(true,model.get("name"))};}}else{data={id:"all_records",text:app.lang.get("LBL_FILTER_ALL_RECORDS")};}
callback(data);}},formatSelection:function(item){var ctx={},safeString;safeString=Handlebars.Utils.escapeExpression(item.text);this.$('.choice-filter').html(safeString);ctx.label=app.lang.get("LBL_FILTER");ctx.enabled=this.filterDropdownEnabled;return this._select2formatSelectionTemplate(ctx);},formatResult:function(option){return this._select2formatResultTemplate(option.text);},handleEditFilter:function(){var filterId=this.filterNode.val(),filterModel=this.layout.filters.get(filterId);if(filterModel&&filterModel.get("editable")!==false){this.layout.trigger("filter:create:open",filterModel);}},handleModuleChange:function(linkModuleName,linkName){this.filterDropdownEnabled=(linkName!=="all_modules"&&!app.metadata.getModule(linkModuleName).isBwcEnabled);},getTranslatedSelectionText:function(isAllRecords,label){var translatedText,moduleName;if(isAllRecords){moduleName=app.lang.get('LBL_MODULE_NAME',this.layout.layout.currentModule);translatedText=app.lang.get(label,null,{'moduleName':moduleName});}
else{translatedText=app.lang.get(label,['Filters',this.layout.layout.currentModule]);}
return translatedText;},_dispose:function(){if(!_.isEmpty(this.filterNode)){this.filterNode.select2('destroy');}
app.view.View.prototype._dispose.call(this);}})