/*
     * By installing or using this file, you are confirming on behalf of the entity
     * subscribed to the SugarCRM Inc. product ("Company") that Company is bound by
     * the SugarCRM Inc. Master Subscription Agreement ("MSA"), which is viewable at:
     * http://www.sugarcrm.com/master-subscription-agreement
     *
     * If Company is not bound by the MSA, then by installing or using this file
     * you are agreeing unconditionally that Company will be bound by the MSA and
     * certifying that you have authority to bind Company accordingly.
     *
     * Copyright  2004-2013 SugarCRM Inc.  All rights reserved.
     */
({extendsFrom:'RecordView',editAllMode:false,SAVEACTIONS:{SAVE_AND_CREATE:'saveAndCreate',SAVE_AND_VIEW:'saveAndView'},enableDuplicateCheck:false,dupecheckList:null,saveButtonName:'save_button',cancelButtonName:'cancel_button',saveAndCreateButtonName:'save_create_button',saveAndViewButtonName:'save_view_button',restoreButtonName:'restore_button',initialize:function(options){var createViewEvents={};createViewEvents['click a[name='+this.saveButtonName+']']='save';createViewEvents['click a[name='+this.cancelButtonName+']']='cancel';createViewEvents['click a[name='+this.saveAndCreateButtonName+']']='saveAndCreate';createViewEvents['click a[name='+this.saveAndViewButtonName+']']='saveAndView';createViewEvents['click a[name='+this.restoreButtonName+']']='restoreModel';this.events=_.extend({},this.events,createViewEvents);this.plugins=_.union(this.plugins||[],['FindDuplicates']);this.STATE=_.extend({},this.STATE,{CREATE:'create',SELECT:'select',DUPLICATE:'duplicate'});app.view.invokeParent(this,{type:'view',name:'record',method:'initialize',args:[options]});this.model.off("change",null,this);this.context.lastSaveAction=null;this.context.on('list:dupecheck-list-select-edit:fire',this.editExisting,this);this.meta=_.extend({},app.metadata.getView(this.module,'record'),this.meta);var moduleMetadata=app.metadata.getModule(this.module);this.enableDuplicateCheck=(moduleMetadata&&moduleMetadata.dupCheckEnabled)||false;var fields=(moduleMetadata&&moduleMetadata.fields)?moduleMetadata.fields:[];this.model.relatedAttributes=this.model.relatedAttributes||{};_.each(fields,function(field){var userId,userName,isDuplicate;if(((field.name&&field.name==='assigned_user_id')||(field.id_name&&field.id_name==='assigned_user_id'))&&(field.type&&field.type==='relate')){isDuplicate=this.model.has('assigned_user_id')&&this.model.has('assigned_user_name');userId=isDuplicate?this.model.get('assigned_user_id'):app.user.id;userName=isDuplicate?this.model.get('assigned_user_name'):app.user.attributes.full_name;this.model.set('assigned_user_id',userId);this.model.set('assigned_user_name',userName);this.model.relatedAttributes.assigned_user_id=app.user.id;this.model.relatedAttributes.assigned_user_name=app.user.attributes.full_name;}},this);this.model.on("error:validation",function(){this.alerts.showInvalidModel();},this);},hasUnsavedChanges:function(){if(this.resavingAfterMetadataSync)
return false;return this.model.isNew()&&this.model.hasChanged();},handleSync:function(){},delegateButtonEvents:function(){},_render:function(){app.view.invokeParent(this,{type:'view',name:'record',method:'_render'});this.setButtonStates(this.STATE.CREATE);this.renderDupeCheckList();app.events.trigger('create:model:changed',false);this.model.on('change',function(){app.events.trigger('create:model:changed',this.hasUnsavedChanges());},this);},save:function(){switch(this.context.lastSaveAction){case this.SAVEACTIONS.SAVE_AND_CREATE:this.saveAndCreate();break;case this.SAVEACTIONS.SAVE_AND_VIEW:this.saveAndView();break;default:this.saveAndClose();}},saveAndClose:function(){this.initiateSave(_.bind(function(){if(!this.model.id){this.alerts.showSuccessButDeniedAccess();}
if(app.drawer){app.drawer.close(this.context,this.model);}},this));},cancel:function(){if(app.drawer){app.drawer.close(this.context);}},saveAndCreate:function(){this.context.lastSaveAction=this.SAVEACTIONS.SAVE_AND_CREATE;this.initiateSave(_.bind(function(){if(this.model.id){this.clear();this.model.set(this.model.relatedAttributes);this.resetDuplicateState();}else if(app.drawer){this.alerts.showSuccessButDeniedAccess();if(app.drawer){app.drawer.close(this.context,this.model);}}},this));},saveAndView:function(){this.context.lastSaveAction=this.SAVEACTIONS.SAVE_AND_VIEW;this.initiateSave(_.bind(function(){if(!this.model.id){this.alerts.showSuccessButDeniedAccess();if(app.drawer){app.drawer.close(this.context,this.model);}}else{app.navigate(this.context,this.model);}},this));},restoreModel:function(){this.model.clear();if(this._origAttributes){this.model.set(this._origAttributes);this.model.isCopied=true;}
this.createMode=true;if(!this.disposed){this.render();}
this.setButtonStates(this.STATE.CREATE);},initiateSave:function(callback){this.disableButtons();async.waterfall([_.bind(this.validateModelWaterfall,this),_.bind(this.dupeCheckWaterfall,this),_.bind(this.createRecordWaterfall,this)],_.bind(function(error){this.enableButtons();if(error&&error.status==412&&!error.request.metadataRetry){this.handleMetadataSyncError(error);}else if(!error&&!this.disposed){this.context.lastSaveAction=null;callback();}},this));},validateModelWaterfall:function(callback){this.model.doValidate(this.getFields(this.module),function(isValid){callback(!isValid);});},dupeCheckWaterfall:function(callback){var success=_.bind(function(collection){if(this.disposed){callback(true);}
if(collection.models.length>0){this.handleDuplicateFound(collection);callback(true);}else{this.resetDuplicateState();callback(false);}},this),error=_.bind(function(e){if(e.status==412&&!e.request.metadataRetry){this.handleMetadataSyncError(e);}else{this.alerts.showServerError();callback(true);}},this);if(this.skipDupeCheck()||!this.enableDuplicateCheck){callback(false);}else{this.checkForDuplicate(success,error);}},createRecordWaterfall:function(callback){var success=function(){callback(false);},error=_.bind(function(e){if(e.status==412&&!e.request.metadataRetry){this.handleMetadataSyncError(e);}else if(e.status==404){callback();}else{this.alerts.showServerError();callback(true);}},this);this.saveModel(success,error);},checkForDuplicate:function(success,error){var options={showAlerts:true,success:success,error:error};this.context.trigger("dupecheck:fetch:fire",this.model,options);},handleDuplicateFound:function(){this.setButtonStates(this.STATE.DUPLICATE);this.dupecheckList.show();this.skipDupeCheck(true);},resetDuplicateState:function(){this.setButtonStates(this.STATE.CREATE);this.hideDuplicates();this.skipDupeCheck(false);},getCustomSaveOptions:function(options){return{};},saveModel:function(success,error){var self=this,options;success=_.wrap(success,function(func,model){var successMessage=self.buildSuccessMessage(model);app.file.checkFileFieldsAndProcessUpload(self,{success:function(){var successKey='create-success';func();app.alert.show(successKey,{level:'success',messages:successMessage,autoClose:true,autoCloseDelay:10000,onLinkClick:function(){app.alert.dismiss(successKey);}});}},{deleteIfFails:true});});options={success:success,error:error,viewed:true,relate:(self.model.link)?true:null,showAlerts:{'process':true,'success':false,'error':false},lastSaveAction:this.context.lastSaveAction};options=_.extend({},options,self.getCustomSaveOptions(options));self.model.save(null,options);},buildSuccessMessage:function(model){var modelAttributes,successLabel='LBL_RECORD_SAVED_SUCCESS',successMessageContext;if(model&&model.attributes){modelAttributes=model.attributes;}else{modelAttributes={};successLabel='LBL_RECORD_SAVED';}
successMessageContext=_.extend({module:this.module,moduleSingularLower:this.moduleSingular.toLowerCase()},modelAttributes);return app.lang.get(successLabel,this.module,successMessageContext);},skipDupeCheck:function(skip){var skipDupeCheck,saveButton=this.buttons[this.saveButtonName].getFieldElement();if(_.isUndefined(skip)){skipDupeCheck=saveButton.data('skipDupeCheck');if(_.isUndefined(skipDupeCheck)){skipDupeCheck=false;}
return skipDupeCheck;}else{if(skip){saveButton.data('skipDupeCheck',true);}else{saveButton.data('skipDupeCheck',false);}}},clear:function(){this.model.clear();if(!this.disposed){this.render();}},editExisting:function(model){var origAttributes=this.saveFormData(),skipDupeCheck=this.skipDupeCheck();this.model.clear();this.model.set(this.extendModel(model,origAttributes));this.createMode=false;if(!this.disposed){this.render();}
this.toggleEdit(true);this.hideDuplicates();this.skipDupeCheck(skipDupeCheck);this.setButtonStates(this.STATE.SELECT);},extendModel:function(newModel,origAttributes){var modelAttributes=_.clone(newModel.attributes);_.each(modelAttributes,function(value,key){if(_.isUndefined(value)||_.isNull(value)||((_.isObject(value)||_.isArray(value)||_.isString(value))&&_.isEmpty(value))){delete modelAttributes[key];}});return _.extend({},origAttributes,modelAttributes);},saveFormData:function(){this._origAttributes=_.clone(this.model.attributes);return this._origAttributes;},setDupeCheckType:function(type){this.context.set('dupelisttype',type);},renderDupeCheckList:function(){this.setDupeCheckType('dupecheck-list-edit');this.context.set('collection',this.createDuplicateCollection(this.model));if(_.isNull(this.dupecheckList)){this.dupecheckList=app.view.createLayout({context:this.context,name:'create-dupecheck',module:this.module});this.addToLayoutComponents(this.dupecheckList);}
this.$('.headerpane').after(this.dupecheckList.$el);this.dupecheckList.hide();this.dupecheckList.render();},addToLayoutComponents:function(component){this.layout._components.push(component);},hideDuplicates:function(){this.dupecheckList.hide();},setButtonStates:function(state){app.view.invokeParent(this,{type:'view',name:'record',method:'setButtonStates',args:[state]});var $saveButtonEl=this.buttons[this.saveButtonName];if($saveButtonEl){switch(state){case this.STATE.CREATE:case this.STATE.SELECT:$saveButtonEl.getFieldElement().text(app.lang.get('LBL_SAVE_BUTTON_LABEL',this.module));break;case this.STATE.DUPLICATE:$saveButtonEl.getFieldElement().text(app.lang.get('LBL_IGNORE_DUPLICATE_AND_SAVE',this.module));break;}}},disableButtons:function(){this.toggleButtons(false);},enableButtons:function(){this.toggleButtons(true);},toggleButtons:function(enable){_.each(this.buttons,function(button){switch(button.type){case'button':case'rowaction':button.getFieldElement().toggleClass('disabled',!enable);break;case'actiondropdown':button.$('a.dropdown-toggle').toggleClass('disabled',!enable);break;}});},alerts:{showInvalidModel:function(){app.alert.show('invalid-data',{level:'error',messages:'ERR_RESOLVE_ERRORS',autoClose:true});},showServerError:function(){app.alert.show('server-error',{level:'error',messages:'ERR_GENERIC_SERVER_ERROR',autoClose:false});},showSuccessButDeniedAccess:function(){app.alert.show('invalid-data',{level:'warning',messages:'LBL_RECORD_SAVED_ACCESS_DENIED',autoClose:true,autoCloseDelay:9000});}}})