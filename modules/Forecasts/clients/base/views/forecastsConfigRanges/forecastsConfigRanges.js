/*********************************************************************************
     * By installing or using this file, you are confirming on behalf of the entity
     * subscribed to the SugarCRM Inc. product ("Company") that Company is bound by
     * the SugarCRM Inc. Master Subscription Agreement (“MSA”), which is viewable at:
     * http://www.sugarcrm.com/master-subscription-agreement
     *
     * If Company is not bound by the MSA, then by installing or using this file
     * you are agreeing unconditionally that Company will be bound by the MSA and
     * certifying that you have authority to bind Company accordingly.
     *
     * Copyright (C) 2004-2013 SugarCRM Inc.  All rights reserved.
     ********************************************************************************/
({label:'',forecastRangesField:{},bucketsDomField:{},categoryRangesField:{},selection:'',fieldRanges:{},disableRanges:false,titleSelectedRange:'',titleSelectedValues:'',titleViewNameTitle:'',toggleTitleTpl:{},fieldsMeta:{},includedCommitStages:[],events:{'click #btnAddCustomRange a':'addCustomRange','click #btnAddCustomRangeWithoutProbability a':'addCustomRange','click .addCustomRange':'addCustomRange','click .removeCustomRange':'removeCustomRange','keyup input[type=text]':'updateCustomRangeLabel','change input[type=checkbox]':'updateCustomRangeIncludeInTotal','click .resetLink':'onResetLinkClicked'},initialize:function(options){app.view.View.prototype.initialize.call(this,options);this.titleViewNameTitle=app.lang.get('LBL_FORECASTS_CONFIG_TITLE_RANGES','Forecasts');this.label=_.first(this.meta.panels).label;this.fieldsMeta=_.first(this.meta.panels).fields;this.forecastRangesField=this.fieldsMeta.forecast_ranges;this.bucketsDomField=this.fieldsMeta.buckets_dom;this.categoryRangesField=this.fieldsMeta.category_ranges;this.model.set($.extend(true,{},app.metadata.getModule('Forecasts','config')));this.updateTitleValues(this.model);this.forecastByModule=app.lang.getAppListStrings('moduleList')[this.model.get('forecast_by')];this.includedCommitStages=this.model.get('commit_stages_included'),this.forecastRangesField.value=this.model.get('forecast_ranges');this.bucketsDomField.value=this.model.get('buckets_dom');this.toggleTitleTpl=app.template.getView('forecastsConfigHelpers.toggleTitle','Forecasts');},onResetLinkClicked:function(evt){evt.preventDefault();evt.stopImmediatePropagation();},bindDataChange:function(){if(this.model){this.model.on('change',function(model){this.updateTitleValues(model);},this);}},updateTitleValues:function(model){if(_.isUndefined(model)){model=this.model;}
var forecastRanges=model.get('forecast_ranges'),rangeObjs=model.get(forecastRanges+'_ranges'),tmpObj={},str='';_.each(rangeObjs,function(vals){tmpObj[vals.min]=vals.max;});_.each(tmpObj,function(max,min){str+=min+"% - "+max+"%, ";});str=str.slice(0,str.length-2);this.titleSelectedValues=str;this.titleSelectedRange=app.lang.getAppListStrings('forecasts_config_ranges_options_dom')[forecastRanges];if(_.isFunction(this.toggleTitleTpl)){this.updateTitle();}},updateTitle:function(){var tplVars={title:this.titleViewNameTitle,message:this.titleSelectedRange,selectedValues:this.titleSelectedValues,viewName:'forecastsConfigRanges'};this.$el.find('#'+this.name+'Title').html(this.toggleTitleTpl(tplVars));},_render:function(){this.disableRanges=this.model.get('has_commits');this.selection=this.model.get('forecast_ranges');app.view.View.prototype._render.call(this);this.$el.addClass('accordion-group');this._addForecastRangesSelectionHandler();this.updateTitle();return this;},_addForecastRangesSelectionHandler:function(){var elements=this.$el.find(':radio[name="'+this.forecastRangesField.name+'"]');_.each(elements,function(el){$(el).change({view:this},this.selectionHandler);if($(el).prop('checked')){$(el).triggerHandler("change");}},this);},selectionHandler:function(event){var view=event.data.view,oldValue,bucket_dom,hideElement,showElement;oldValue=view.selection;view.selection=this.value;bucket_dom=view.bucketsDomField.options[this.value];hideElement=view.$el.find('#'+oldValue+'_ranges');showElement=view.$el.find('#'+this.value+'_ranges');if(showElement.children().length==0){this.value=='show_custom_buckets'?view._customSelectionHandler(this,showElement):view._selectionHandler(this,showElement);view.connectSliders.call(view,this.value,view.fieldRanges);}
if(hideElement){hideElement.toggleClass('hide',true);}
if(showElement){showElement.toggleClass('hide',false);}
view.model.set(this.name,this.value);view.model.set(view.bucketsDomField.name,bucket_dom);},_selectionHandler:function(element,showElement){var bucket_dom=this.bucketsDomField.options[element.value];this.fieldRanges[element.value]={};showElement.append('<p>'+app.lang.get('LBL_FORECASTS_CONFIG_'+element.value.toUpperCase()+'_RANGES_DESCRIPTION','Forecasts',this)+'</p>');_.each(app.lang.getAppListStrings(bucket_dom),function(label,key){if(key!='exclude'){var rangeField,model=new Backbone.Model(),fieldSettings;model.set(key,this.view.model.get(this.category+'_ranges')[key]);fieldSettings={view:this.view,def:this.view.fieldsMeta.category_ranges[key],viewName:'edit',context:this.view.context,module:this.view.module,model:model,meta:app.metadata.getField('range')};rangeField=app.view.createField(fieldSettings);this.showElement.append('<b>'+label+':</b>').append(rangeField.el);rangeField.render();this.view.fieldRanges[this.category][key]=rangeField;rangeField.sliderDoneDelegate=function(category,key,view){return function(value){this.view.updateRangeSettings(category,key,value);};}(this.category,key,this.view);}},{view:this,showElement:showElement,category:element.value});showElement.append($('<p>'+app.lang.get("LBL_FORECASTS_CONFIG_RANGES_EXCLUDE_INFO","Forecasts")+'</p>'));},_customSelectionHandler:function(element,showElement){var bucket_dom=this.bucketsDomField.options[element.value],bucket_dom_options=[],rangeField,_ranges;this.fieldRanges[element.value]={};showElement.append('<p>'+app.lang.get('LBL_FORECASTS_CONFIG_'+element.value.toUpperCase()+'_RANGES_DESCRIPTION','Forecasts',this)+'</p>');if(!this.model.has(element.value+'_ranges')){this.model.set(element.value+'_ranges',{});}
_.each(app.lang.getAppListStrings(bucket_dom),function(label,key){if(_.isUndefined(this.view.model.get(this.category+'_ranges')[key])){_ranges=this.view.model.get(this.category+'_ranges');_ranges[key]={min:0,max:100,in_included_total:false};this.view.model.set(this.category+'_ranges',_ranges);}else{_ranges=this.view.model.get(this.category+'_ranges');_ranges[key].in_included_total=(_.contains(this.view.includedCommitStages,key));this.view.model.set(this.category+'_ranges',_ranges);}
bucket_dom_options.push([key,label]);},{view:this,category:element.value});this.model.set(element.value+'_options',bucket_dom_options);this.model.on('change:'+element.value+'_options',function(event){this.view.validateCustomRangeLabels(this.category);},{view:this,category:element.value});this._renderCustomRangesLayout(showElement,element.value);_.each(app.lang.getAppListStrings(bucket_dom),function(label,key){rangeField=this.view._renderCustomRange(key,label,showElement,element.value);this.view.fieldRanges[element.value][key]=rangeField;},{view:this,showElement:showElement,category:element.value});if(this._getLastCustomRangeIndex(element.value,'custom')){this.$el.find('#btnAddCustomRange').hide();}
if(this._getLastCustomRangeIndex(element.value,'custom_without_probability')){this.$el.find('#btnAddCustomRangeWithoutProbability').hide();}},_renderCustomRangesLayout:function(showElement,category){var template='<p><b>{{str "LBL_FORECASTS_RANGES_BASED_TITLE" "Forecasts"}}</b></p>'+'<div id="plhCustomProbabilityRanges">'+'   <div id="plhCustomDefault"></div>'+'   <p><b>{{str "LBL_FORECASTS_CUSTOM_BASED_TITLE" "Forecasts"}}</b></p>'+'   <div id="plhCustom"></div>'+'   <div id="plhExclude">'+'       <div class="btn-group" id="btnAddCustomRange"><a class="btn" href="javascript:void(0)" data-type="custom" data-category="{{category}}"><i class="icon-plus"></i></a></div>'+'   </div>'+'</div>'+'<p><b>{{str "LBL_FORECASTS_CUSTOM_NO_BASED_TITLE" "Forecasts"}}</b></p>'+'<div id="plhCustomWithoutProbability">'+'   <div class="btn-group" id="btnAddCustomRangeWithoutProbability"><a class="btn" href="javascript:void(0)" data-type="custom_without_probability" data-category="{{category}}"><i class="icon-plus"></i></a></div>'+'</div>';showElement.append(Handlebars.compile(template)({category:category}));},_renderCustomRange:function(key,label,showElement,category){var customType=key,customIndex=0,isExclude=false,currentPlh=showElement,rangeField,model=new Backbone.Model(),fieldSettings,lastCustomRange;if(key.substring(0,26)=='custom_without_probability'){customType='custom_without_probability';customIndex=key.substring(27);currentPlh=this.$el.find('#plhCustomWithoutProbability');}else if(key.substring(0,6)=='custom'){customType='custom';customIndex=key.substring(7);currentPlh=this.$el.find('#plhCustom');}else if(key.substring(0,7)=='exclude'){customType='custom_default';currentPlh=this.$el.find('#plhExclude');isExclude=true;}else{customType='custom_default';currentPlh=this.$el.find('#plhCustomDefault');}
model.set(key,this.model.get(category+'_ranges')[key]);var fieldDef=this.fieldsMeta.category_ranges[key]||this.fieldsMeta.category_ranges[customType];fieldSettings={view:this,def:_.clone(fieldDef),viewName:'forecastsCustomRange',context:this.context,module:this.module,model:model,meta:app.metadata.getField('range')};fieldSettings.def.name=key;fieldSettings.def.view='forecastsCustomRange';fieldSettings.def.enabled=true;rangeField=app.view.createField(fieldSettings);currentPlh.append(rangeField.el);rangeField.label=label;rangeField.customType=customType;rangeField.customIndex=customIndex;rangeField.isExclude=isExclude;rangeField.in_included_total=(_.contains(this.includedCommitStages,key));rangeField.category=category;rangeField.render();rangeField.$el.find(rangeField.fieldTag).noUiSlider('enable');lastCustomRange=this._getLastCustomRange(category,rangeField.customType);if(!_.isUndefined(lastCustomRange)){lastCustomRange.$el.find('.addCustomRange').parent().hide();}
_.isEmpty(rangeField.label)?rangeField.$el.find('.control-group').addClass('error'):rangeField.$el.find('.control-group').removeClass('error');rangeField.sliderDoneDelegate=function(category,key,view){return function(value){this.view.updateRangeSettings(category,key,value);};}(category,key,this);return rangeField;},_getLastCustomRangeIndex:function(category,customType){var lastCustomRangeIndex=0;if(this.fieldRanges[category]){_.each(this.fieldRanges[category],function(range){if(range.customType==customType&&range.customIndex>lastCustomRangeIndex){lastCustomRangeIndex=range.customIndex;}},this);}
return lastCustomRangeIndex;},_getLastCustomRange:function(category,customType){if(this.fieldRanges[category]&&!_.isEmpty(this.fieldRanges[category])){var lastCustomRange=undefined;_.each(this.fieldRanges[category],function(range){if(range.customType==customType&&(_.isUndefined(lastCustomRange)||range.customIndex>lastCustomRange.customIndex)){lastCustomRange=range;}},this);if(_.isUndefined(lastCustomRange)){if(customType=='custom'){lastCustomRange=this.fieldRanges[category].upside||this.fieldRanges[category].include;}else{lastCustomRange=this.fieldRanges[category].exclude;}}}
return lastCustomRange;},addCustomRange:function(event){var view=this,category=$(event.currentTarget).data('category')||null,customType=$(event.currentTarget).data('type')||null,ranges=view.model.get(category+'_ranges'),bucket_dom_options=view.model.get(category+'_options'),showElement=(customType=='custom')?view.$el.find('#plhCustom'):view.$el.find('#plhCustomWithoutProbability'),label=app.lang.get('LBL_FORECASTS_CUSTOM_RANGES_DEFAULT_NAME','Forecasts'),key,rangeField,lastCustomRange,lastCustomRangeIndex,lastOptionIndex;if(_.isNull(category)||_.isNull(customType)||_.isUndefined(ranges)&&_.isUndefined(bucket_dom_options)){return false;}
lastCustomRange=view._getLastCustomRange(category,customType);lastCustomRangeIndex=view._getLastCustomRangeIndex(category,customType);lastCustomRangeIndex++;key=customType+'_'+lastCustomRangeIndex;if(customType!='custom'){ranges[key]={min:0,max:0,in_included_total:false};}else if(ranges.exclude.max-ranges.exclude.min>3){ranges[key]={min:parseInt(ranges.exclude.max,10)-1,max:parseInt(ranges.exclude.max,10),in_included_total:false};ranges.exclude.max=parseInt(ranges.exclude.max,10)-2;if(!_.isUndefined(view.fieldRanges[category].exclude.$el)){view.fieldRanges[category].exclude.$el.find(view.fieldRanges[category].exclude.fieldTag).noUiSlider('move',{handle:'upper',to:ranges.exclude.max});}}else if(ranges[lastCustomRange.name].max-ranges[lastCustomRange.name].min>3){ranges[key]={min:parseInt(ranges[lastCustomRange.name].min,10),max:parseInt(ranges[lastCustomRange.name].min,10)+1,in_included_total:false};ranges[lastCustomRange.name].min=parseInt(ranges[lastCustomRange.name].min,10)+2;if(!_.isUndefined(lastCustomRange.$el)){lastCustomRange.$el.find(lastCustomRange.fieldTag).noUiSlider('move',{handle:'lower',to:ranges[lastCustomRange.name].min});}}else{ranges[key]={min:parseInt(ranges[lastCustomRange.name].min,10)-2,max:parseInt(ranges[lastCustomRange.name].min,10)-1,in_included_total:false};}
view.model.unset(category+'_ranges',{silent:true});view.model.set(category+'_ranges',ranges);rangeField=view._renderCustomRange(key,label,showElement,category);if(!_.isUndefined(rangeField)&&!_.isNull(rangeField)){view.fieldRanges[category][key]=rangeField;}
_.each(bucket_dom_options,function(item,key){if(item[0]==this.value){lastOptionIndex=key;}},{value:lastCustomRange.name});bucket_dom_options.splice(lastOptionIndex+1,0,[key,label]);view.model.unset(category+'_options',{silent:true});view.model.set(category+'_options',bucket_dom_options);if(customType=='custom'){view.$el.find('#btnAddCustomRange').hide();view.connectSliders.call(view,category,view.fieldRanges);}else{view.$el.find('#btnAddCustomRangeWithoutProbability').hide();_.each(view.fieldRanges[category],function(item){if(item.customType==this.key&&item.customIndex<this.index&&!_.isUndefined(item.$el)){item.$el.find('.addCustomRange').parent().hide();}},this);}},removeCustomRange:function(event){var view=this,category=$(event.currentTarget).data('category')||null,fieldKey=$(event.currentTarget).data('key')||null,ranges=view.model.get(category+'_ranges'),bucket_dom_options=view.model.get(category+'_options'),range,previousCustomRange,lastCustomRangeIndex,lastCustomRange,optionIndex;if(_.isNull(category)||_.isNull(fieldKey)||_.isUndefined(view.fieldRanges[category])||_.isUndefined(view.fieldRanges[category][fieldKey])||_.isUndefined(ranges)||_.isUndefined(bucket_dom_options))
{return false;}
range=view.fieldRanges[category][fieldKey];if(_.indexOf(['include','upside','exclude'],range.name)!=-1){return false;}
if(range.customType=='custom'){_.each(this.fieldRanges[category],function(item){if(item.customType=='custom'&&item.customIndex<range.customIndex){previousCustomRange=item;}},this);if(_.isUndefined(previousCustomRange)){previousCustomRange=!_.isUndefined(view.fieldRanges[category].upside)?view.fieldRanges[category].upside:view.fieldRanges[category].include;}
ranges[previousCustomRange.name].min=+ranges[range.name].min;if(!_.isUndefined(previousCustomRange.$el)){previousCustomRange.$el.find(previousCustomRange.fieldTag).noUiSlider('move',{handle:'lower',to:ranges[previousCustomRange.name].min});}}
view.fieldRanges[category][range.name].remove();delete ranges[range.name];delete view.fieldRanges[category][range.name];_.each(bucket_dom_options,function(item,key){if(item[0]==this.value){optionIndex=key;}},{value:range.name});bucket_dom_options.splice(optionIndex,1);view.model.unset(category+'_options',{silent:true});view.model.set(category+'_options',bucket_dom_options);view.model.unset(category+'_ranges',{silent:true});view.model.set(category+'_ranges',ranges);lastCustomRangeIndex=view._getLastCustomRangeIndex(category,range.customType);if(range.customType=='custom'){if(lastCustomRangeIndex==0){view.$el.find('#btnAddCustomRange').show();}
view.connectSliders.call(view,category,view.fieldRanges);}else{if(lastCustomRangeIndex==0){view.$el.find('#btnAddCustomRangeWithoutProbability').show();}}
lastCustomRange=view._getLastCustomRange(category,range.customType);if(!_.isUndefined(lastCustomRange.$el)){lastCustomRange.$el.find('.addCustomRange').parent().show();}},updateCustomRangeLabel:function(event){var view=this,category=$(event.target).data('category')||null,fieldKey=$(event.target).data('key')||null,bucket_dom_options=view.model.get(category+'_options'),optionIndex;if(!_.isNull(category)&&!_.isNull(fieldKey)&&!_.isUndefined(bucket_dom_options)){_.each(bucket_dom_options,function(item,key){if(item[0]==this.value){optionIndex=key;}},{value:fieldKey});bucket_dom_options[optionIndex][1]=$(event.target).val();view.model.unset(category+'_options',{silent:true});view.model.set(category+'_options',bucket_dom_options);}},validateCustomRangeLabels:function(category){_.each(this.model.get(category+'_options'),function(item,key){if(_.isEmpty(item[1])){this.view.fieldRanges[category][item[0]].$el.find('.control-group').addClass('error');this.view.layout.$el.find('[name=save_button]').addClass('disabled');}else{this.view.fieldRanges[category][item[0]].$el.find('.control-group').removeClass('error')}},{view:this});},updateCustomRangeIncludeInTotal:function(event){var view=this,category=$(event.target).data('category')||null,fieldKey=$(event.target).data('key')||null,ranges;if(!_.isNull(category)&&!_.isNull(fieldKey))
{ranges=view.model.get(category+'_ranges');if(!_.isUndefined(ranges)&&!_.isUndefined(ranges[fieldKey]))
{if(fieldKey!=='exclude'&&fieldKey.indexOf('custom_without_probability')==-1){ranges[fieldKey].in_included_total=$(event.target).is(':checked');}else{ranges[fieldKey].in_included_total=false;}
view.model.unset(category+'_ranges',{silent:true});view.model.set(category+'_ranges',ranges);}}},updateRangeSettings:function(category,range,value){var catRange=category+'_ranges',setting=this.model.get(catRange);if(category=='show_custom_buckets'){value.in_included_total=setting[range].in_included_total||false;}
setting[range]=value;this.model.unset(catRange,{silent:true});this.model.set(catRange,setting);},connectSliders:function(ranges,sliders){var rangeSliders=sliders[ranges];if(ranges=='show_binary'){rangeSliders.include.sliderChangeDelegate=function(value){rangeSliders.include.$el.find(rangeSliders.include.fieldTag).noUiSlider('move',{handle:'upper',to:rangeSliders.include.def.maxRange});this.view.setExcludeValueForLastSlider(value,ranges,rangeSliders.include);};}else if(ranges=='show_buckets'){rangeSliders.include.sliderChangeDelegate=function(value){rangeSliders.include.$el.find(rangeSliders.include.fieldTag).noUiSlider('move',{handle:'upper',to:rangeSliders.include.def.maxRange});rangeSliders.upside.$el.find(rangeSliders.upside.fieldTag).noUiSlider('move',{handle:'upper',to:value.min-1});if(value.min<=rangeSliders.upside.$el.find(rangeSliders.upside.fieldTag).noUiSlider('value')[0]+1){rangeSliders.upside.$el.find(rangeSliders.upside.fieldTag).noUiSlider('move',{handle:'lower',to:value.min-2});}};rangeSliders.upside.sliderChangeDelegate=function(value){rangeSliders.include.$el.find(rangeSliders.include.fieldTag).noUiSlider('move',{handle:'lower',to:value.max+1});this.view.setExcludeValueForLastSlider(value,ranges,rangeSliders.upside);};}else if(ranges=='show_custom_buckets'){var i,max,customSliders=_.sortBy(_.filter(rangeSliders,function(item){return item.customType=='custom'}),function(item){return parseInt(item.customIndex,10);}),probabilitySliders=_.union(rangeSliders.include,rangeSliders.upside,customSliders,rangeSliders.exclude);if(probabilitySliders.length){for(i=0,max=probabilitySliders.length;i<max;i++){probabilitySliders[i].connectedSlider=(!_.isUndefined(probabilitySliders[i+1]))?probabilitySliders[i+1]:null;probabilitySliders[i].connectedToSlider=(!_.isUndefined(probabilitySliders[i-1]))?probabilitySliders[i-1]:null;probabilitySliders[i].sliderChangeDelegate=function(value,populateEvent){if(this.name=='include'){this.$el.find(this.fieldTag).noUiSlider('move',{handle:'upper',to:this.def.maxRange});}else if(this.name=='exclude'){this.$el.find(this.fieldTag).noUiSlider('move',{handle:'lower',to:this.def.minRange});}
if(!_.isUndefined(this.connectedSlider)&&!_.isNull(this.connectedSlider)){this.connectedSlider.$el.find(this.connectedSlider.fieldTag).noUiSlider('move',{handle:'upper',to:value.min-1});if(value.min<=this.connectedSlider.$el.find(this.connectedSlider.fieldTag).noUiSlider('value')[0]+1){this.connectedSlider.$el.find(this.connectedSlider.fieldTag).noUiSlider('move',{handle:'lower',to:value.min-2});}
if(_.isUndefined(populateEvent)||populateEvent=='down'){this.connectedSlider.sliderChangeDelegate.call(this.connectedSlider,{min:this.connectedSlider.$el.find(this.connectedSlider.fieldTag).noUiSlider('value')[0],max:this.connectedSlider.$el.find(this.connectedSlider.fieldTag).noUiSlider('value')[1]},'down');}}
if(!_.isUndefined(this.connectedToSlider)&&!_.isNull(this.connectedToSlider)){this.connectedToSlider.$el.find(this.connectedToSlider.fieldTag).noUiSlider('move',{handle:'lower',to:value.max+1});if(value.max>=this.connectedToSlider.$el.find(this.connectedToSlider.fieldTag).noUiSlider('value')[1]-1){this.connectedToSlider.$el.find(this.connectedToSlider.fieldTag).noUiSlider('move',{handle:'upper',to:value.max+2});}
if(_.isUndefined(populateEvent)||populateEvent=='up'){this.connectedToSlider.sliderChangeDelegate.call(this.connectedToSlider,{min:this.connectedToSlider.$el.find(this.connectedToSlider.fieldTag).noUiSlider('value')[0],max:this.connectedToSlider.$el.find(this.connectedToSlider.fieldTag).noUiSlider('value')[1]},'up');}}};}}}},setExcludeValueForLastSlider:function(value,ranges,slider){var excludeRange={min:0,max:100},settingName=ranges+'_ranges',setting=this.model.get(settingName);excludeRange.max=value.min-1;excludeRange.min=slider.def.minRange;setting.exclude=excludeRange;this.model.set(settingName,setting);}})